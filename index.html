<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>家計診断アプリ</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='24' fill='%230D1B2A'/%3E%3Ccircle cx='50' cy='22' r='6' fill='white'/%3E%3Ccircle cx='44' cy='44' r='4' fill='%23F59E0B'/%3E%3C/svg%3E" />
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
<header>
  <div class="wrap">
    <h1 class="brandTitle">
      <span class="logoMark" aria-hidden="true">
        <svg viewBox="0 0 64 64" role="img">
          <circle cx="32" cy="32" r="24" fill="#0D1B2A"></circle>
          <circle cx="50" cy="22" r="6" fill="#FFFFFF"></circle>
          <circle cx="44" cy="44" r="4" fill="#F59E0B"></circle>
        </svg>
      </span>
      家計診断アプリ
    </h1>
    <p class="muted">記録→診断。週次は「簡易スコア」、月次は「総合レポート」</p>
  </div>
</header>

<!-- Onboarding -->
<div class="modalOverlay" id="onboardingModal" style="background:rgba(13,27,42,0.95); z-index:9999;">
  <div class="modal">
    <div class="modalBody" style="padding:32px 24px; text-align:center;">
      <div id="slide1" class="onboardSlide">
        <div style="font-size:60px; margin-bottom:16px;">🩺</div>
        <h2 style="color:var(--primary); margin-bottom:12px;">記録から、診断へ。</h2>
        <p class="muted" style="line-height:1.8; text-align:left; font-size:14px; margin-bottom:32px;">
          家計簿は「記録」だけだと判断がむずい。<br>
          このアプリは、あなたの家計を<b>「診断」</b>して、<b>点数</b>で現在地を出します。
        </p>
        <button class="primary" style="width:100%; padding:14px;" onclick="nextSlide(2)">次へ</button>
      </div>

      <div id="slide2" class="onboardSlide" style="display:none;">
        <div style="font-size:60px; margin-bottom:16px;">🧾</div>
        <h2 style="color:var(--primary); margin-bottom:12px;">カテゴリ→金額→（必要なら）納得</h2>
        <p class="muted" style="line-height:1.8; text-align:left; font-size:14px; margin-bottom:32px;">
          入力は「カテゴリ → 金額 →（質カテゴリなら）納得度・きっかけ」。<br>
          迷わない導線にしています。
        </p>
        <div style="display:flex; gap:12px;">
          <button class="ghost" style="flex:1;" onclick="nextSlide(1)">戻る</button>
          <button class="primary" style="flex:2;" onclick="nextSlide(3)">次へ</button>
        </div>
      </div>

      <div id="slide3" class="onboardSlide" style="display:none;">
        <div style="font-size:60px; margin-bottom:16px;">📈</div>
        <h2 style="color:var(--primary); margin-bottom:12px;">週次と月次で改善。</h2>
        <p class="muted" style="line-height:1.8; text-align:left; font-size:14px; margin-bottom:32px;">
          週次は「先週（日〜土）」の簡易スコア。<br>
          月次は「総合スコア＋各項目」をレポートで出します。
        </p>
        <div style="display:flex; gap:12px;">
          <button class="ghost" style="flex:1;" onclick="nextSlide(2)">戻る</button>
          <button class="primary" style="flex:2;" onclick="finishOnboarding()">始める</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Result Modal -->
<div class="modalOverlay" id="resultModal">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">診断結果</div>
      <div class="bar">
        <button class="ghost" onclick="copyResult()">コピー</button>
        <button class="danger" onclick="closeModal('resultModal')">閉じる</button>
      </div>
    </div>
    <div class="modalBody" id="modalResultView"></div>
    <pre id="modalResultText" style="display:none;"></pre>
  </div>
</div>

<!-- Entry Modal -->
<div class="modalOverlay" id="entryModal">
  <div class="modal modal-like-app" id="entryModalCard">

    <div class="entryTop">
      <div class="dateRow">
        <div class="dateLabel">日付</div>
        <button class="dateNavBtn" type="button" id="entryPrevDay" aria-label="prev">‹</button>
        <div class="datePill" id="entryDateText">----</div>
        <button class="dateNavBtn" type="button" id="entryNextDay" aria-label="next">›</button>
      </div>
      <p class="muted small" style="margin:10px 0 0;">入力は「カテゴリ → 金額 →（必要なら）納得」</p>
      <p class="muted small" style="margin:6px 0 0;">固定費（住居/光熱/通信/サブスク）は月次入力です</p>
    </div>

    <div class="entryMid" id="entryMid">
      <div class="catTitle">カテゴリー</div>
      <div class="catGridApp" id="entryCatArea"></div>

      <!-- ✅ B案：カテゴリの“下”に金額/メモ（最初は非表示） -->
      <div class="entryFields" id="entryFields" style="display:none;">
        <div class="amountRow" id="amountRow">
          <div class="amountLabel">支出</div>
          <div class="amountInputWrap">
            <input id="entryAmount" type="number" inputmode="numeric" placeholder="例：1200" />
            <div class="yenSuffix">円</div>
          </div>
        </div>

        <div class="memoRow">
          <div class="memoLabel">メモ</div>
          <input id="entryMemoTop" type="text" placeholder="未入力" />
        </div>
      </div>

      <!-- 質カテゴリ：金額確定後に表示 -->
      <div id="entrySatWrap" class="qualityBox" style="display:none;">
        <div class="small" style="margin-bottom:6px;">納得度・きっかけは任意です</div>
        <div class="qualityRow">
          <div class="qualityLabel">納得度</div>
          <select id="entrySat">
            <option value="">未入力</option>
            <option value="1">1（払う必要なかった）</option>
            <option value="2">2（微妙だった）</option>
            <option value="3">3（払ってよかった）</option>
            <option value="4">4（最高だった）</option>
          </select>
        </div>

        <div class="qualityRow">
          <div class="qualityLabel">きっかけ</div>
          <select id="entryTrigger">
            <option value="">未入力</option>
            <option value="tired">疲れ</option>
            <option value="stress">ストレス</option>
            <option value="hungry">空腹</option>
            <option value="reward">ご褒美</option>
            <option value="social">付き合い</option>
            <option value="timesave">時短</option>
            <option value="bored">なんとなく</option>
          </select>
        </div>

        <div class="qualityRow">
          <div class="qualityLabel">詳細</div>
          <input type="text" id="entryNote" placeholder="例：疲れてコンビニで…" />
        </div>
      </div>

      <p id="entryMsg" class="muted" style="min-height:18px; margin:10px 0 0;"></p>
    </div>

    <!-- 下部操作バー（sticky） -->
    <div class="entryActionBar">
      <button class="ghost" type="button" id="entryCloseBtn">閉じる</button>
      <button class="primary" type="button" id="entryPrimaryBtn">次へ</button>
    </div>

    <div class="entryDayBox">
      <div class="bar entryDayBar">
        <div style="font-weight:1000;" id="entryDaySumPill">本日合計：0円</div>
        <div class="small" id="entryDayCountPill">0件</div>
      </div>
      <div id="entryDayList" class="entryDayList"></div>
    </div>

    <input type="hidden" id="entryCategoryHidden">
    <input type="hidden" id="txDate">
  </div>
</div>

<!-- Day Detail Modal -->
<div class="modalOverlay" id="dayDetailModal">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">履歴：<span id="dayDetailDateText">----</span></div>
      <button class="ghost" onclick="closeModal('dayDetailModal')">✕</button>
    </div>
    <div class="modalBody">
      <div class="bar dayDetailBar">
        <div style="font-weight:1000; color:var(--ink);" id="dayDetailSumPill">合計：0円</div>
        <div class="small" id="dayDetailCountPill">0件</div>
      </div>
      <div class="miniList" id="dayDetailList" style="max-height:60vh; overflow-y:auto;"></div>
      <div style="height:20px;"></div>
    </div>
  </div>
</div>

<div class="wrap">
  <section class="screen active" id="screen-input">
    <div class="box">
      <h2 style="display:flex; align-items:center; gap:8px;">
        <span style="font-size:20px;">📝</span> 行動ログ
      </h2>

      <div class="weeklyCard">
        <div>
          <div class="weeklyTitle">先週の診断</div>
          <div class="small" id="weeklyHintText">先週（日〜土）の簡易スコア</div>
        </div>
        <div class="bar">
          <span class="weeklyBadge" id="weeklyBadge">未開封</span>
          <button class="primary" style="padding:8px 12px; font-size:12px;" onclick="openWeeklyReport()">開封</button>
        </div>
      </div>

      <div class="calendarBox" id="calendarBox">
        <div class="calHeader">
          <span class="pill" id="calMonthPill" style="font-size:14px; padding:6px 12px;">----</span>
          <div class="bar" style="gap:4px;">
            <button class="ghost" style="padding:8px;" onclick="calMove(-1)">◀</button>
            <button class="ghost" style="padding:8px;" onclick="calMove(1)">▶</button>
          </div>
        </div>
        <div class="calGrid" id="calDow"></div>
        <div class="calGrid" id="calGrid"></div>
      </div>
      <p style="text-align:center; margin-top:10px; font-size:12px; color:#888;">日付タップで入力 / 長押しで履歴</p>
    </div>
  </section>

  <section class="screen" id="screen-list">
    <div class="box">
      <h2>📊 行動データ</h2>
      <div class="row">
        <label>
          対象月
          <div class="bar" style="gap:8px;">
            <input type="month" id="viewMonth">
            <button class="primary" style="padding:12px;" onclick="renderList()">更新</button>
          </div>
        </label>
      </div>
      <div class="bar" style="margin-top:12px; justify-content:flex-end;">
         <button class="danger" style="font-size:12px; padding:8px 12px;" onclick="clearMonthTx()">月データ削除</button>
      </div>
      <div id="listArea" style="margin-top:16px;"></div>
    </div>
  </section>

  <section class="screen" id="screen-score">
    <div class="box boxSafeBottom">
      <div class="bar" style="justify-content:space-between;">
        <div>
          <h2 style="font-size:20px; margin:0;">🩺 定期健康診断（月次）</h2>
          <div class="small">総合スコア＋各項目（表示はすべて100点満点）</div>
        </div>
        <div><span class="pill" id="profileMiniPill">目安：未設定</span></div>
      </div>

      <div class="row" style="margin-top:18px;">
        <label>診断する月 <input type="month" id="scoreMonth"></label>
        <label>手取り月収 (円) <input type="number" id="incomeYen" placeholder="例：300000"></label>
      </div>

      <h3>固定費 (月1回)</h3>
      <div class="row">
        <label>住居費<input type="number" id="housingYen" placeholder="家賃など"></label>
        <label>光熱費<input type="number" id="utilityYen" placeholder="電気ガス水道"></label>
        <label>通信費<input type="number" id="netYen" placeholder="スマホ・Net"></label>
        <label>サブスク<input type="number" id="subYen" placeholder="定期支払"></label>
      </div>

      <h3>貯蓄・投資</h3>
      <div class="row">
        <label>今月の貯蓄額<input type="number" id="savingYen" placeholder="貯金+投資"></label>
      </div>

      <div style="margin-top:22px;">
        <button class="primary" style="width:100%; padding:16px; font-size:16px;" onclick="showMonthlyScore()">診断結果を見る</button>
      </div>
    </div>
  </section>

  <section class="screen" id="screen-profile">
    <div class="box boxSafeBottom">
      <h2>⚙️ 設定・プロフィール</h2>
      <div class="small">属性（世帯人数・年齢階級）は、将来の比較機能の土台になります</div>

      <div class="row" style="margin-top:16px;">
        <label>世帯人数
          <select id="profileHousehold">
            <option value="unknown">未設定</option>
            <option value="single">1人暮らし</option>
            <option value="twoPlus">2人以上</option>
          </select>
        </label>
        <label>年齢階級
          <select id="profileAgeBand">
            <option value="unknown">未設定</option>
            <option value="u29">〜29歳</option>
            <option value="30s">30代</option>
            <option value="40s">40代</option>
            <option value="50s">50代</option>
            <option value="60p">60歳以上</option>
          </select>
        </label>
      </div>

      <div class="bar" style="margin-top:12px; justify-content:flex-end;">
        <button class="primary" onclick="saveProfile()">保存</button>
      </div>

      <div class="box" style="margin:16px 0 0;">
        <h3>📕 チュートリアル</h3>
        <button class="ghost" style="width:100%;" onclick="resetOnboarding()">最初の説明をもう一度見る</button>
      </div>

      <div class="adminBox">
        <h3>📥 データ管理</h3>
        <div class="small" style="margin-bottom:12px;">機種変更や分析用に、全データを書き出し・読み込みできます。</div>
        <button class="dark" style="width:100%; margin-bottom:12px;" onclick="downloadData()">全データを書き出し (Export)</button>
        <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(this)">
        <button class="ghost" style="width:100%;" onclick="document.getElementById('importFile').click()">ファイルを読み込み (Import)</button>
      </div>
    </div>
  </section>
</div>

<div class="navSpacer" aria-hidden="true"></div>

<nav class="bottomNav">
  <div class="tabs">
    <button class="tabBtn active" id="tab-input" onclick="switchScreen('input')">
      <span class="icon">✏️</span><span>ログ</span>
    </button>
    <button class="tabBtn" id="tab-list" onclick="switchScreen('list')">
      <span class="icon">📊</span><span>データ</span>
    </button>
    <button class="tabBtn" id="tab-score" onclick="switchScreen('score')">
      <span class="icon">🩺</span><span>診断</span>
    </button>
    <button class="tabBtn" id="tab-profile" onclick="switchScreen('profile')">
      <span class="icon">⚙️</span><span>設定</span>
    </button>
  </div>
</nav>

<script src="./app.js"></script>
</body>
</html>
